<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informativo - Arya Promotora</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos originais mantidos */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: #0a0a0a; color: #ffffff; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; align-items: center; overflow: hidden; padding: 30px; }
        .top-section { text-align: center; width: 100%; max-width: 1200px; }
        .logo { max-width: 220px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 0 15px rgba(255, 179, 71, 0.2 ); }
        .clock-container { margin-top: 15px; }
        #time { font-size: 8rem; font-weight: 700; color: #FFB347; line-height: 1; text-shadow: 0 0 20px rgba(255, 179, 71, 0.4); }
        #date { font-size: 2.4rem; font-weight: 300; color: #cccccc; text-transform: capitalize; margin-top: 8px; }
        .weather-container { background: rgba(255, 255, 255, 0.05); border-radius: 24px; padding: 28px 40px; width: 90%; max-width: 1000px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255, 179, 71, 0.3); backdrop-filter: blur(8px); }
        .weather-item { text-align: center; min-width: 280px; }
        .temp-main { font-size: 5.5rem; font-weight: 700; color: #ffffff; }
        .weather-desc { font-size: 2rem; color: #FFB347; text-transform: capitalize; margin-top: -6px; }
        .weather-details { font-size: 1.8rem; color: #aaaaaa; text-align: left; line-height: 1.6; }
        .location { font-size: 1.6rem; color: #FFB347; margin-bottom: 8px; font-weight: 700; }
        #loading { font-size: 1.8rem; color: #FFB347; }
        @media (max-width: 1920px) { #time { font-size: 8rem; } .temp-main { font-size: 5.5rem; } }
        @media (max-width: 1366px) { #time { font-size: 6rem; } .temp-main { font-size: 4.5rem; } .logo { max-width: 180px; } }
    </style>
</head>
<body>
    <div class="top-section">
        <img src="/static/logo.png" alt="Arya Promotora" class="logo">
        <div class="clock-container">
            <div id="time">00:00:00</div>
            <div id="date">Carregando data...</div>
        </div>
    </div>

    <div class="weather-container" id="weather-box">
        <div id="loading">Carregando previsão do tempo...</div>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const saoPauloTime = new Date(utc - (3 * 3600000));
            const h = String(saoPauloTime.getHours()).padStart(2, '0');
            const m = String(saoPauloTime.getMinutes()).padStart(2, '0');
            const s = String(saoPauloTime.getSeconds()).padStart(2, '0');
            document.getElementById('time').textContent = `${h}:${m}:${s}`;
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            let dateString = saoPauloTime.toLocaleDateString('pt-BR', options);
            dateString = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            document.getElementById('date').textContent = dateString;
        }

        async function updateWeather() {
            const lat = -23.5333;
            const lon = -46.5333;
            const apiKey = 'ee60a5b81a7eb26554d26d3892694d8e'; 
            const weatherBox = document.getElementById('weather-box');

            try {
                // Tenta OpenWeatherMap primeiro
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=pt_br`);
                if (!response.ok) throw new Error('OpenWeatherMap indisponível');
                
                const data = await response.json();
                
                // Lógica de detecção de chuva aprimorada
                // 1. Pelo código/descrição principal
                let isRaining = data.weather[0].main.toLowerCase().includes('rain') || 
                                data.weather[0].main.toLowerCase().includes('drizzle') || 
                                data.weather[0].main.toLowerCase().includes('thunderstorm');
                
                // 2. Pelo volume de chuva (se existir o objeto 'rain')
                let rainVolume = 0;
                if (data.rain) {
                    rainVolume = data.rain['1h'] || data.rain['3h'] || 0;
                    if (rainVolume > 0) isRaining = true;
                }

                // 3. Cruzamento com Open-Meteo (Backup em tempo real)
                // Se o OWM disser que não chove, mas o usuário diz que sim, vamos conferir a precipitação na Open-Meteo
                const backupResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=precipitation,weather_code&timezone=America%2FSao_Paulo`);
                if (backupResponse.ok) {
                    const backupData = await backupResponse.json();
                    if (backupData.current.precipitation > 0 || [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(backupData.current.weather_code)) {
                        isRaining = true;
                        if (rainVolume === 0) rainVolume = backupData.current.precipitation;
                    }
                }

                const rainText = isRaining ? `⚠️ Chuva detectada` : "Sem previsão de chuva agora";
                const rainColor = isRaining ? '#ff4444' : '#44ff44';

                weatherBox.innerHTML = `
                    <div class="weather-item">
                        <div class="location">VILA MATILDE, SP</div>
                        <div class="temp-main">${Math.round(data.main.temp)}°C</div>
                        <div class="weather-desc">${data.weather[0].description}</div>
                    </div>
                    <div class="weather-details">
                        <p style="font-size: 2rem; color: #ffffff; margin: 0 0 5px 0;">Sensação: ${Math.round(data.main.feels_like)}°C</p>
                        <p style="font-size: 2rem; color: #ffffff; margin: 0 0 10px 0;">Umidade: ${data.main.humidity}%</p>
                        <p style="color: ${rainColor}; font-size: 1.8rem; margin: 0; font-weight: 700;">
                            ${rainText} ${rainVolume > 0 ? `(${rainVolume}mm)` : ''}
                        </p>
                    </div>
                `;

            } catch (error) {
                console.error("Erro na atualização do clima:", error);
                // Se tudo falhar, tenta o fallback completo da Open-Meteo
                fetchOpenMeteoFallback(lat, lon, weatherBox);
            }
        }

        async function fetchOpenMeteoFallback(lat, lon, container) {
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code&timezone=America%2FSao_Paulo`);
                const data = await response.json();
                const current = data.current;
                
                const weatherCodes = { 0: "Céu Limpo", 1: "Principalmente Limpo", 2: "Parcialmente Nublado", 3: "Nublado", 45: "Nevoeiro", 48: "Nevoeiro com geada", 51: "Garoa Leve", 53: "Garoa Moderada", 55: "Garoa Densa", 61: "Chuva Leve", 63: "Chuva Moderada", 65: "Chuva Forte", 80: "Pancadas Leves", 81: "Pancadas Moderadas", 82: "Pancadas Fortes", 95: "Trovoada", 96: "Trovoada com Granizo Leve", 99: "Trovoada com Granizo Forte" };
                const desc = weatherCodes[current.weather_code] || "Tempo Estável";
                const isRaining = current.precipitation > 0 || [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99].includes(current.weather_code);
                
                container.innerHTML = `
                    <div class="weather-item">
                        <div class="location">VILA MATILDE, SP</div>
                        <div class="temp-main">${Math.round(current.temperature_2m)}°C</div>
                        <div class="weather-desc">${desc}</div>
                    </div>
                    <div class="weather-details">
                        <p style="font-size: 2rem; color: #ffffff; margin: 0 0 5px 0;">Sensação: ${Math.round(current.apparent_temperature)}°C</p>
                        <p style="font-size: 2rem; color: #ffffff; margin: 0 0 10px 0;">Umidade: ${current.relative_humidity_2m}%</p>
                        <p style="color: ${isRaining ? '#ff4444' : '#44ff44'}; font-size: 1.8rem; margin: 0; font-weight: 700;">
                            ${isRaining ? '⚠️ Chuva detectada' : 'Sem previsão de chuva agora'} ${current.precipitation > 0 ? `(${current.precipitation}mm)` : ''}
                        </p>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<div id="loading">Erro ao carregar clima.</div>`;
            }
        }

        updateClock();
        setInterval(updateClock, 1000);
        updateWeather();
        setInterval(updateWeather, 300000); 
        setTimeout(() => { window.location.reload(); }, 3600000);
    </script>
</body>
</html>
