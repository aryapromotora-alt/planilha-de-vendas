<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Visão TV - Resumo de Vendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="refresh" content="60"> <!-- Mantém atualização automática -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ... seu CSS igual, sem alterações ... */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html, body {
        height: 100%;
        overflow: hidden;
    }

    body {
        font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #121212;
        color: #ffffff;
        line-height: 1.6;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .spreadsheet-container {
        overflow: hidden;
        padding: 0;
        margin: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    table.spreadsheet-table {
        width: 100%;
        height: 100%;
        border-collapse: collapse;
        font-size: 1.8rem;
        font-weight: 500;
        color: #ffffff;
        margin: 0 auto;
    }

    table.spreadsheet-table th {
        background-color: #0A0A0A;
        color: #FFB347;
        padding: 1.0rem 0.5rem;
        text-align: center;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 1.5rem;
        letter-spacing: 0.8px;
        border-bottom: 2px solid #FFB347;
        position: sticky;
        top: 0;
        z-index: 5;
        text-shadow: 0 0 4px rgba(255, 215, 0, 0.6);
    }

    table.spreadsheet-table td {
        padding: 1.0rem 0.5rem;
        text-align: center;
        border-bottom: 1px solid #333;
        transition: background-color 0.2s;
        font-weight: 500;
    }
    
    table.spreadsheet-table td:nth-child(n+2):nth-child(-n+6) {
        border-left: 1px solid #FFB347;
        border-right: 1px solid #FFB347;
    }

    table.spreadsheet-table tbody tr:nth-child(odd) {
        background-color: #1a1a1a;
    }

    table.spreadsheet-table tbody tr:nth-child(even) {
        background-color: #1d1d1d;
    }

    table.spreadsheet-table tbody tr:hover {
        background-color: #2a2a2a;
    }

    .employee-name {
        background-color: #0A0A0A !important;
        color: #FFB347 !important;
        font-weight: 700;
        text-align: left;
        padding-left: 1.0rem;
        text-transform: uppercase;
        text-shadow: 0 0 4px rgba(255, 215, 0, 0.6);
    }

    .total-cell {
        background-color: #0A0A0A !important;
        font-weight: 600;
        color: #FFB347 !important;
        border-left: 2px solid #FFB347;
        text-shadow: 0 0 4px rgba(255, 215, 0, 0.6);
    }

    .daily-totals {
        background-color: #0A0A0A !important;
        font-weight: 600;
        border-top: 2px solid #FFB347;
    }

    .daily-totals td {
        color: #FFB347 !important;
        font-weight: 600;
        background-color: #0A0A0A !important;
        text-shadow: 0 0 4px rgba(255, 215, 0, 0.6);
    }
  </style>
</head>
<body>
  <div class="spreadsheet-container">
    <table class="spreadsheet-table">
      <thead>
        <tr>
          <th>Vendedor</th>
          <th>Segunda</th>
          <th>Terça</th>
          <th>Quarta</th>
          <th>Quinta</th>
          <th>Sexta</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="tv-tbody">
        <!-- Dados serão inseridos aqui via JS -->
      </tbody>
    </table>
  </div>

  <script>
    // ✅ Configurações: ordem inicial dos vendedores (mantém a ordem atual da sua TV)
    // Substitua esta lista pela ordem que você quer (ex: como está hoje na TV)
    // ⚠️ IMPORTANTE: atualize esta lista quando adicionar/remover vendedores
    const employeeDisplayOrder = [
      "Vendedor1",
      "Vendedor2",
      "Vendedor3",
      "Vendedor4"
      // ... adicione todos os vendedores na ordem desejada
      // Novos devem ser adicionados no final
    ];

    // Função para formatar moeda (igual ao seu filtro Jinja2)
    function formatBRL(value) {
      return parseFloat(value || 0).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Função para carregar e renderizar dados
    async function loadAndRenderData() {
      try {
        // ✅ Busca dados das duas abas (portabilidade e novo) e combina
        const [dataPort, dataNovo] = await Promise.all([
          fetch('/api/data?type=portabilidade', { credentials: 'include' }).then(r => r.json()),
          fetch('/api/data?type=novo', { credentials: 'include' }).then(r => r.json())
        ]);

        const employees = dataPort.employees || dataNovo.employees || [];
        const portData = dataPort.spreadsheetData || {};
        const novoData = dataNovo.spreadsheetData || {};

        // ✅ Cria mapa de dados combinados (soma PORTABILIDADE + NOVO por vendedor)
        const combinedData = {};
        employees.forEach(emp => {
          const user = emp.username;
          const port = portData[user] || {};
          const novo = novoData[user] || {};
          combinedData[user] = {
            nome: user,
            seg: (port.monday || 0) + (novo.monday || 0),
            ter: (port.tuesday || 0) + (novo.tuesday || 0),
            qua: (port.wednesday || 0) + (novo.wednesday || 0),
            qui: (port.thursday || 0) + (novo.thursday || 0),
            sex: (port.friday || 0) + (novo.friday || 0)
          };
          combinedData[user].total = combinedData[user].seg + combinedData[user].ter +
                                   combinedData[user].qua + combinedData[user].qui + combinedData[user].sex;
        });

        // ✅ Calcula totais diários (soma de todos os vendedores)
        const dias = ['seg', 'ter', 'qua', 'qui', 'sex'];
        const totais = { seg: 0, ter: 0, qua: 0, qui: 0, sex: 0 };
        dias.forEach(dia => {
          totais[dia] = employees.reduce((sum, emp) => {
            return sum + (combinedData[emp.username]?.[dia] || 0);
          }, 0);
        });

        // ✅ Renderiza linhas na ordem de employeeDisplayOrder
        const tbody = document.getElementById('tv-tbody');
        tbody.innerHTML = '';

        employeeDisplayOrder.forEach(username => {
          const linha = combinedData[username];
          if (!linha) return; // ignora se removido

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="employee-name">${linha.nome}</td>
            <td>R$ ${formatBRL(linha.seg)}</td>
            <td>R$ ${formatBRL(linha.ter)}</td>
            <td>R$ ${formatBRL(linha.qua)}</td>
            <td>R$ ${formatBRL(linha.qui)}</td>
            <td>R$ ${formatBRL(linha.sex)}</td>
            <td class="total-cell">R$ ${formatBRL(linha.total)}</td>
          `;
          tbody.appendChild(tr);
        });

        // ✅ Linha de total diário
        const totalGeral = totais.seg + totais.ter + totais.qua + totais.qui + totais.sex;
        const totalRow = document.createElement('tr');
        totalRow.className = 'daily-totals';
        totalRow.innerHTML = `
          <td><strong>Total Diário</strong></td>
          <td>R$ ${formatBRL(totais.seg)}</td>
          <td>R$ ${formatBRL(totais.ter)}</td>
          <td>R$ ${formatBRL(totais.qua)}</td>
          <td>R$ ${formatBRL(totais.qui)}</td>
          <td>R$ ${formatBRL(totais.sex)}</td>
          <td class="total-cell">R$ ${formatBRL(totalGeral)}</td>
        `;
        tbody.appendChild(totalRow);

      } catch (error) {
        console.error('Erro ao carregar dados para TV:', error);
        // Em caso de falha, recarrega em 5s (evita tela vazia)
        setTimeout(loadAndRenderData, 5000);
      }
    }

    // Carrega dados imediatamente e a cada 60s (mantém <meta refresh> como fallback)
    loadAndRenderData();
    setInterval(loadAndRenderData, 60000); // 60s
  </script>
</body>
</html>